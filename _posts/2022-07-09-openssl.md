---
layout: post
title: Tự tạo RootCA với OpenSSL
subtitle: Tổng hợp những lệnh openssl phổ biến nhất
tags: [openssl, certificate, rootca, pkcs12]
categories: [public-key-infrastructure]
---


Đây là hướng dẫn đơn giản để tạo nhanh một RootCA, tạo khóa, cấp certificate, và export tệp tin PKCS#12. Đồng thời cũng giới thiệu một số lệnh để xem hoặc kiểm tra chúng. 

## Tạo CA với certificate tự ký

Chúng ta sẽ tạo hai thành phần của Root CA là khóa riêng `ca_key.pem` và certificate tự ký `ca_cert.pem` bằng câu lệnh sau:

```
openssl req -x509 -newkey rsa:4096 -keyout ca_key.pem -out ca_cert.pem -nodes -days 365 -subj "/CN=localhost/O=Certificate\ Demo"
```

Câu lệnh trên thực hiện 3 công đoạn gồm:

1. Tạo khóa RSA 4096 bit (`-newkey`), lưu khóa vào file ca_key.pem (`-keyout`), và không sử dụng mã hóa DES (`-nodes`)
2. Tạo một Certificate Signing Request (CSR) hiệu lực trong 365 ngày (`subj`, `-days`)
3. Thực hiện ký lên CSR bằng khóa riêng vừa tạo và lưu kết quả vào file ca_cert.pem theo chuẩn X.509 (`-x509`, `-out`)

Định dạng PEM là định dạng mặc định, dữ liệu sẽ được biên mã base64 với phần header và footer trông sẽ như sau: 

```
-----BEGIN CERTIFICATE/PRIVATE KEY-----
MIIFTTCCAzWgAwIBAgIUEluiBWNg5mBOFzEHjIfVKJ5cTPIwDQYJKoZIhvcNAQEL
BQAwNjESMBAGA1UEAwwJbG9jYWxob3N0MSAwHgYDVQQKDBdDbGllbnQgQ2VydGlm
...
-----END CERTIFICATE/PRIVATE KEY-----
```

Một định dạng khác là DER, được biên mã nhị phân. Một số trường hợp khác sử dụng `.key`, hoặc `.crt` để ám chỉ ý nghĩa của file, tuy nhiên định dạng bên trong của chúng vẫn là PEM hoặc DER.

## Tạo khóa riêng và CSR cho user

Chúng ta sẽ tạo khóa riêng `alice_key.pem` và CSR `alice_csr.pem` cho Alice. Khóa của user nên có số bít nhỏ hơn so với CA.

```
openssl req -newkey rsa:2048 -keyout alice_key.pem -out alice_csr.pem -nodes -subj "/CN=Alice"
```

## Cấp certificate cho user

CA tạo ra certificate cho user bằng cách ký lên CSR của user đó. Để  thực hiện điều này ra dùng hai đối số `-CA` và `-CAkey`. Thời gian hiệu lực phải nhỏ hơn thời gian hiệu lực của RootCA, ta sẽ sử dụng `-days` để xác định thời gian này.

```
openssl x509 -req -in alice_csr.pem -CA ca_cert.pem -CAkey ca_key.pem -out alice_cert.pem -set_serial 01 -days 180
```

## Tạo tệp PKCS#12

Chúng ta có thể gói cả khóa riêng và certificate vào trong một tệp `.p12` hoặc `.pfx`, sử dụng định dạng PKCS#12. Quá trình cũng yêu cầu nhập một mật khẩu để bảo vệ khóa.

```
openssl pkcs12 -export -in alice_cert.pem -inkey alice_key.pem -out alice.p12
```

## Kiểm tra/xem khóa, CSR, certificate, PKCS#12

1. Kiểm tra khóa:

```
openssl rsa -check -in alice_key.pem
```

2. Kiểm tra CSR:

```
openssl req -text -noout -verify -in alice_csr.pem
```

3. Xem certificate:

```
openssl x509 -text -noout -in alice_cert.pem
```

4. Xem tệp PKCS#12:

```
openssl pkcs12 -info -in alice.p12
```